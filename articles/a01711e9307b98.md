---
title: "fly.ioã§PostgreSQLã‚’ä½¿ã£ã¦Ruby on Railsã‚¢ãƒ—ãƒªã‚’ç„¡æ–™ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Ruby, Rails, fly, PostgreSQL, å€‹äººé–‹ç™º]
published: false
---
## 1. ç’°å¢ƒ

- MacBook Air(M1)
- macOS Ventura version13.1

## 2. fly.ioã¨ã¯ï¼Ÿ

https://fly.io/
>Run your full stack apps (and databases!) all over the world. No ops required.

ç¿»è¨³ã™ã‚‹ã¨ã€
ã€Œãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãŠã‚ˆã³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ï¼‰ã‚’ä¸–ç•Œä¸­ã§å®Ÿè¡Œã§ãã¾ã™ã€‚é‹ç”¨ã¯ä¸è¦ã§ã™ã€‚ã€
ã¨ã„ã†ã“ã¨ã‚‰ã—ã„ã§ã™ã€‚
ãã—ã¦ãªã‚“ã¨ç‰©ç†ã‚µãƒ¼ãƒãƒ¼ãŒæ±äº¬ã«ã‚ã‚‹ã¿ãŸã„ã€‚
ã•ã‚‰ã«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚Œã¦ã„ã‚‹é™ã‚Šã‚ã‚‰ã‚†ã‚‹ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã€postgreSQLã‚‚ä½¿ãˆã¦ç„¡æ–™åˆ©ç”¨æ ã‚‚ã‚ã‚‹ã€‚

ã¨ã„ã†ã“ã¨ã§ä»Šå›ã¯Railsã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## 3. flyctlã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã‚’æ“ä½œã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã™ã€‚
OSã«åˆã‚ã›ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

### 3.1. macOS
```
brew install flyctl
```
### 3.2. Linux
```
curl -L https://fly.io/install.sh | sh
```
### 3.3. Windows
```
iwr https://fly.io/install.ps1 -useb | iex
```

## 4. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
https://fly.io/app/sign-up
ä¸Šè¨˜ã®ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚
```
flyctl auth signup
```
![](/images/a01711e9307b98/2023-01-25-22-17-43.png)

ãã—ã¦Emailã‹GitHubã‚’ä½¿ç”¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

![](/images/a01711e9307b98/2023-01-25-22-21-34.png)

ã“ã®ã‚ˆã†ãªç”»é¢ã«é·ç§»ã™ã‚‹ã®ã§ã€ã€Œã‚«ãƒ¼ãƒ‰ç•ªå·ã€ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã«æ”¯æ‰•ã„æƒ…å ±ã‚’å…¥åŠ›ã—ã€ã€ŒAdd Cardã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](/images/a01711e9307b98/2023-01-25-22-24-59.png)

ã“ã‚Œã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹

Railsã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚ã™ã§ã«ç”¨æ„ã—ã¦ã‚ã‚‹æ–¹ã¯ãã‚Œã‚’ä½¿ã‚ã‚Œã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã—ã€ã¨ã‚Šã‚ãˆãšãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ãŸã„ã¨ã„ã†æ–¹ã¯ä»Šå›ç§ãŒåˆ©ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’GitHubä¸Šã«ä¸Šã’ã¦ãŠãã¾ã—ãŸã®ã§ãã‚Œã‚’`git clone`ãªã©ã—ã¦åˆ©ç”¨ã•ã‚Œã¦ãã ã•ã„ã€‚

https://github.com/te19oishi/fly.io-rails-app

## 5. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã™ã‚‹

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã®ãŸã‚ã«ã€ã©ã®ã‚ˆã†ã«é…ç½®ã™ã‚‹ã‹ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«ä¼ãˆã‚‹ãŸã‚ã®fly.tomlãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ã§ã™ã®ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ç”Ÿæˆã—ã¾ã™ã€‚

```
fly launch
```
### 5.1. Dockerfileã‚’Overwriteã™ã‚‹ã‹

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã®ã§ã€`y`ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

```:terminal
? Overwrite "/Users/ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå/Dockerfile"? (y/N) 
```

### 5.2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã‚’æ±ºã‚ã‚‹

æ¬¡ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åå‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
å…¥åŠ›ã›ãšã«Enterã‚’æŠ¼ã™ã¨è‡ªå‹•çš„ã«åå‰ãŒæ±ºã¾ã‚Šã¾ã™ã€‚

```:terminal
? Choose an app name (leave blank to generate one):
```

### 5.3. ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ±ºã‚ã‚‹

æ¬¡ã«ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®é¸æŠã§ã™ã€‚ã‚«ãƒ¼ã‚½ãƒ«(>)ãŒå‡ºã¦ã€ä¸Šä¸‹ã‚’æŠ¼ã™ã¨ç§»å‹•ã—ã¾ã™ã€‚ã“ã“ã§ã¯æ—¥æœ¬ã®æ±äº¬(Tokyo,Japan)ã‚’é¸æŠã—ã¾ã™ã€‚

```:terminal
? Choose a region for deployment:  [Use arrows to move, type to filter]
  çœç•¥
  :
  Miami, Florida (US) (mia)
> Tokyo, Japan (nrt)
  Chicago, Illinois (US) (ord)
  :
  çœç•¥
```

ä»¥ä¸‹ã‹ã‚‰åˆ†ã‹ã‚‹ã‚ˆã†ã«ã€fly.tomlãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã€flyä¸Šã§ã‚¢ãƒ—ãƒªãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

```:terminal
Created app ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å in organization personal
Admin URL: https://fly.io/apps/ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å
Hostname: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å.fly.dev
Set secrets on ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å: RAILS_MASTER_KEY
Wrote config file fly.toml
```
### 5.4. PostgreSQLã‚’è¨­å®šã™ã‚‹

æ¬¡ã«PostgreSQLã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã®ã§ã€ã“ã“ã§`y`ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

```:terminal
? Would you like to set up a Postgresql database now? (y/N) 
```

ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒæ§˜ã«ã‚«ãƒ¼ã‚½ãƒ«(>)ãŒå‡ºã¦ãã‚‹ã®ã§ã€ä»Šå›ã¯æ–™é‡‘ãŒã‹ã‹ã‚‰ãªã„ã‚ˆã†ã«Developmentã‚’é¸æŠã—ã¾ã™ã€‚

```:terminal
? Select configuration:  [Use arrows to move, type to filter]
> Development - Single node, 1x shared CPU, 256MB RAM, 1GB disk
  Production - Highly available, 2x shared CPUs, 4GB RAM, 40GB disk
  Production - Highly available, 4x shared CPUs, 8GB RAM, 80GB disk
  Specify custom configuration
```

ã—ã°ã‚‰ãå¾…ã¤ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

```:terminal
Postgres cluster ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å-db created
  Username:    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ 
  Password:    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
  Hostname:    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å.internal
  Proxy port:  ãƒ—ãƒ­ã‚­ã‚·ãƒãƒ¼ãƒˆ
  Postgres port:  Postgresãƒãƒ¼ãƒˆ
  Connection string: æ¥ç¶šæ–‡å­—åˆ—
```

### 5.5. Redisã‚’ä½¿ã†ã‹é¸æŠã™ã‚‹

ãã—ã¦Upstashã®Redisã‚’ä½¿ã†ã‹å•ã‚ã‚Œã¾ã™ãŒã€ä»Šå›ã¯`N`ã¨ã—ã¾ã™ã€‚ã¾ãŸæ©Ÿä¼šãŒã‚ã‚Œã°æ›¸ãã‹ã‚‚ã§ã™ã€‚

```:terminal
? Would you like to set up an Upstash Redis database now? (y/N)
```

ã™ã‚‹ã¨fly deployã§ã‚‚ã†ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¦ã—ã¾ã†ã‚ˆã†ã§ã™ã€‚

```:terminal
Now: run 'fly deploy' to deploy your Rails app.
```

### 5.6. ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

```
fly deploy
```

ã“ã‚Œã§ã—ã°ã‚‰ãå¾…ã¡ã¾ã™ã€‚ãã—ã¦æœ€å¾Œã«

```:terminal
deployed successfully
```
ã¨å‡ºåŠ›ã•ã‚Œã‚Œã°å®Œäº†ã§ã™ã€‚

### 5.7. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã™ã‚‹

ãƒ‡ãƒ—ãƒ­ã‚¤ã®è©³ç´°ãªæƒ…å ±ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
flyctl status
```
ã“ã“ã§ã€`running`ã‚„`succesful`ç­‰å‡ºåŠ›ã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸã—ã¦ã„ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚

## 6. ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹

æœ€å¾Œã«ã¡ã‚ƒã‚“ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã§ããŸã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
`https://ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å.fly.dev`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
![](/images/a01711e9307b98/2023-01-25-23-41-39.png)
ã¡ã‚ƒã‚“ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¦ã„ã¾ã—ãŸã€‚